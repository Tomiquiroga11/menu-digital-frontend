<h2>Gestionar Mis Productos</h2>

<div class="card">
  <h3>{{ isEditing ? 'Editar Producto' : 'Crear Nuevo Producto' }}</h3>
  
  <form [formGroup]="productoForm" (ngSubmit)="onSubmit()">
    
    <div>
      <label for="nombre">Nombre:</label>
      <input id="nombre" type="text" formControlName="nombre" placeholder="Ej. Hamburguesa Doble">
      <div *ngIf="productoForm.get('nombre')?.invalid && productoForm.get('nombre')?.touched">
        <small style="color: red;">El nombre es requerido.</small>
      </div>
    </div>

    <div>
      <label for="descripcion">Descripci√≥n:</label>
      <input id="descripcion" type="text" formControlName="descripcion" placeholder="Ingredientes...">
    </div>

    <div>
      <label for="precio">Precio Base ($):</label>
      <input id="precio" type="number" formControlName="precio" min="0">
      
      <div *ngIf="productoForm.get('tieneDescuento')?.value" 
           style="margin-top: 5px; font-size: 0.9rem; color: #27ae60; font-weight: bold;">
           
           <span>Precio con Descuento: </span>
           <span style="text-decoration: line-through; color: #999; margin-right: 5px;">
             ${{ productoForm.get('precio')?.value }}
           </span>
           <span>${{ precioFinalCalculado }}</span>

      </div>
    </div>

    <div>
      <label for="categoria">Categor√≠a:</label>
      <select id="categoria" formControlName="categoriaId">
        <option value="" disabled selected>-- Selecciona --</option>
        <option *ngFor="let cat of categorias" [value]="cat.id">{{ cat.nombre }}</option>
      </select>
    </div>

    <div style="grid-column: span 2;">
      <label for="imagen">URL de Imagen:</label>
      <input id="imagen" type="text" formControlName="imagenUrl" placeholder="https://...">
    </div>

    <div class="checkbox-group" style="grid-column: span 2; display: flex; gap: 20px; flex-wrap: wrap; margin-top: 10px;">
      <div class="checkbox-container">
        <input id="destacado" type="checkbox" formControlName="estaDestacado">
        <label for="destacado">Destacado ‚≠ê</label>
      </div>
      <div class="checkbox-container">
        <input id="hh" type="checkbox" formControlName="tieneHappyHour">
        <label for="hh">Happy Hour üç∫</label>
      </div>
      <div class="checkbox-container">
        <input id="desc" type="checkbox" formControlName="tieneDescuento">
        <label for="desc">Con Descuento %</label>
      </div>
    </div>

    <div *ngIf="productoForm.get('tieneDescuento')?.value" style="grid-column: span 2;">
      <label for="porc">Porcentaje de Descuento (%):</label>
      <input id="porc" type="number" formControlName="porcentajeDescuento" min="0" max="100">
    </div>

    <div style="display: flex; gap: 10px; margin-top: 20px; grid-column: span 2;">
      <button type="submit" [disabled]="productoForm.invalid">
        {{ isEditing ? 'Guardar Cambios' : 'Crear Producto' }}
      </button>
      <button type="button" *ngIf="isEditing" (click)="cancelEdit()" style="background-color: #7f8c8d;">
        Cancelar
      </button>
    </div>
  </form>
</div>

<hr>

<h3>Mis Productos</h3>

<div class="table-container" *ngIf="productos.length > 0">
  <table>
    <thead>
      <tr>
        <th>Img</th>
        <th>Producto</th>
        <th>Precio</th>
        <th>Estado / Promos</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let prod of productos">
        <td class="img-col">
          <img [src]="prod.imagenUrl || 'assets/placeholder.png'" alt="Foto" class="prod-thumb" onerror="this.src='https://placehold.co/50x50?text=No+Img'">
        </td>
        <td>
          <span class="prod-name">{{ prod.nombre }}</span>
          <span class="prod-desc">{{ prod.descripcion }}</span>
        </td>
        
        <td>
          <div style="display: flex; flex-direction: column;">
            <span *ngIf="prod.precioOriginal" 
                  style="text-decoration: line-through; color: #999; font-size: 0.85rem;">
              ${{ prod.precioOriginal }}
            </span>
            
            <span class="prod-price" 
                  [style.color]="prod.precioOriginal ? '#27ae60' : 'inherit'">
              ${{ prod.precio }}
            </span>
          </div>
        </td>

        <td>
          <div style="display: flex; flex-direction: column; gap: 5px;">
             <span *ngIf="prod.estaDestacado" class="badge-destacado" style="align-self: flex-start;">‚≠ê Destacado</span>
             
             <button (click)="toggleHappyHour(prod)" 
                    [style.background-color]="prod.tieneHappyHour ? '#8E44AD' : '#eee'"
                    [style.color]="prod.tieneHappyHour ? 'white' : '#666'"
                    class="btn-toggle">
              {{ prod.tieneHappyHour ? 'üç∫ HH Activo' : 'üç∫ HH Off' }}
            </button>

            <button (click)="toggleDescuento(prod)"
                    [style.background-color]="prod.tieneDescuento ? '#27ae60' : '#eee'"
                    [style.color]="prod.tieneDescuento ? 'white' : '#666'"
                    class="btn-toggle">
              {{ prod.tieneDescuento ? '-' + prod.porcentajeDescuento + '% OFF' : 'üí≤ Sin Desc.' }}
            </button>
          </div>
        </td>
        <td>
          <div class="acciones-col">
            <button (click)="onEdit(prod)" class="btn-edit">Editar</button>
            <button (click)="onDelete(prod.id)" class="btn-delete">Borrar</button>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<div *ngIf="productos.length === 0" style="text-align: center; margin-top: 20px; color: #888;">
  <p>No tienes productos creados todav√≠a.</p>
</div>